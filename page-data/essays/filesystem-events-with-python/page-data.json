{"componentChunkName":"component---src-templates-essay-template-js","path":"/essays/filesystem-events-with-python/","result":{"data":{"markdownRemark":{"id":"4fe13340-479b-598d-9f1d-8e4357c4fbad","excerpt":"Recently I had to implement a shell utility to monitor when a file is added in a directory. In this post, I will describe how we used the watchdog Python…","html":"<p>Recently I had to implement a shell utility to monitor when a file is added in a directory. In this post, I will describe how we used the <a href=\"https://pythonhosted.org/watchdog\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">watchdog Python library</a> to implement the utility and the problems I faced in the way.</p>\n<!--more-->\n<p>Watchdog is a library that implements a transparent API to communicate with <a href=\"https://pythonhosted.org/watchdog/installation.html#supported-platforms-and-caveats\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">native operational system APIs</a> and fall back to polling the disk periodically when needed. It supports APIs from BSD, Linux, macOS, and Windows.</p>\n<p>In this example, I will describe the watcher class that looks for new jpg files in a network mounted directory and the event handler class to process each file. First, let’s take a look on <code class=\"language-text\">ImageWatcher</code>:</p>\n<p><div id=\"gist92477792\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-watcher-py\" class=\"file my-2\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-python  \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip>\n      <tr>\n        <td id=\"file-watcher-py-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"></td>\n        <td id=\"file-watcher-py-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>import</span> <span class=pl-s1>sys</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"></td>\n        <td id=\"file-watcher-py-LC2\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>import</span> <span class=pl-s1>time</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"></td>\n        <td id=\"file-watcher-py-LC3\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"></td>\n        <td id=\"file-watcher-py-LC4\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>from</span> <span class=pl-s1>watchdog</span>.<span class=pl-s1>observers</span> <span class=pl-k>import</span> <span class=pl-v>Observer</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"></td>\n        <td id=\"file-watcher-py-LC5\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>from</span> .<span class=pl-s1>events</span> <span class=pl-k>import</span> <span class=pl-v>ImagesEventHandler</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L6\" class=\"blob-num js-line-number\" data-line-number=\"6\"></td>\n        <td id=\"file-watcher-py-LC6\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L7\" class=\"blob-num js-line-number\" data-line-number=\"7\"></td>\n        <td id=\"file-watcher-py-LC7\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>class</span> <span class=pl-v>ImagesWatcher</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L8\" class=\"blob-num js-line-number\" data-line-number=\"8\"></td>\n        <td id=\"file-watcher-py-LC8\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>__init__</span>(<span class=pl-s1>self</span>, <span class=pl-s1>src_path</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L9\" class=\"blob-num js-line-number\" data-line-number=\"9\"></td>\n        <td id=\"file-watcher-py-LC9\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__src_path</span> <span class=pl-c1>=</span> <span class=pl-s1>src_path</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L10\" class=\"blob-num js-line-number\" data-line-number=\"10\"></td>\n        <td id=\"file-watcher-py-LC10\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__event_handler</span> <span class=pl-c1>=</span> <span class=pl-v>ImagesEventHandler</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L11\" class=\"blob-num js-line-number\" data-line-number=\"11\"></td>\n        <td id=\"file-watcher-py-LC11\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__event_observer</span> <span class=pl-c1>=</span> <span class=pl-v>Observer</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L12\" class=\"blob-num js-line-number\" data-line-number=\"12\"></td>\n        <td id=\"file-watcher-py-LC12\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L13\" class=\"blob-num js-line-number\" data-line-number=\"13\"></td>\n        <td id=\"file-watcher-py-LC13\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>run</span>(<span class=pl-s1>self</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L14\" class=\"blob-num js-line-number\" data-line-number=\"14\"></td>\n        <td id=\"file-watcher-py-LC14\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-en>start</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L15\" class=\"blob-num js-line-number\" data-line-number=\"15\"></td>\n        <td id=\"file-watcher-py-LC15\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-k>try</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L16\" class=\"blob-num js-line-number\" data-line-number=\"16\"></td>\n        <td id=\"file-watcher-py-LC16\" class=\"blob-code blob-code-inner js-file-line\">            <span class=pl-k>while</span> <span class=pl-c1>True</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L17\" class=\"blob-num js-line-number\" data-line-number=\"17\"></td>\n        <td id=\"file-watcher-py-LC17\" class=\"blob-code blob-code-inner js-file-line\">                <span class=pl-s1>time</span>.<span class=pl-en>sleep</span>(<span class=pl-c1>1</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L18\" class=\"blob-num js-line-number\" data-line-number=\"18\"></td>\n        <td id=\"file-watcher-py-LC18\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-k>except</span> <span class=pl-v>KeyboardInterrupt</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L19\" class=\"blob-num js-line-number\" data-line-number=\"19\"></td>\n        <td id=\"file-watcher-py-LC19\" class=\"blob-code blob-code-inner js-file-line\">            <span class=pl-s1>self</span>.<span class=pl-en>stop</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L20\" class=\"blob-num js-line-number\" data-line-number=\"20\"></td>\n        <td id=\"file-watcher-py-LC20\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L21\" class=\"blob-num js-line-number\" data-line-number=\"21\"></td>\n        <td id=\"file-watcher-py-LC21\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>start</span>(<span class=pl-s1>self</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L22\" class=\"blob-num js-line-number\" data-line-number=\"22\"></td>\n        <td id=\"file-watcher-py-LC22\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-en>__schedule</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L23\" class=\"blob-num js-line-number\" data-line-number=\"23\"></td>\n        <td id=\"file-watcher-py-LC23\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__event_observer</span>.<span class=pl-en>start</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L24\" class=\"blob-num js-line-number\" data-line-number=\"24\"></td>\n        <td id=\"file-watcher-py-LC24\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L25\" class=\"blob-num js-line-number\" data-line-number=\"25\"></td>\n        <td id=\"file-watcher-py-LC25\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>stop</span>(<span class=pl-s1>self</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L26\" class=\"blob-num js-line-number\" data-line-number=\"26\"></td>\n        <td id=\"file-watcher-py-LC26\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__event_observer</span>.<span class=pl-en>stop</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L27\" class=\"blob-num js-line-number\" data-line-number=\"27\"></td>\n        <td id=\"file-watcher-py-LC27\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__event_observer</span>.<span class=pl-en>join</span>()</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L28\" class=\"blob-num js-line-number\" data-line-number=\"28\"></td>\n        <td id=\"file-watcher-py-LC28\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L29\" class=\"blob-num js-line-number\" data-line-number=\"29\"></td>\n        <td id=\"file-watcher-py-LC29\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>__schedule</span>(<span class=pl-s1>self</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L30\" class=\"blob-num js-line-number\" data-line-number=\"30\"></td>\n        <td id=\"file-watcher-py-LC30\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-s1>__event_observer</span>.<span class=pl-en>schedule</span>(</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L31\" class=\"blob-num js-line-number\" data-line-number=\"31\"></td>\n        <td id=\"file-watcher-py-LC31\" class=\"blob-code blob-code-inner js-file-line\">            <span class=pl-s1>self</span>.<span class=pl-s1>__event_handler</span>,</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L32\" class=\"blob-num js-line-number\" data-line-number=\"32\"></td>\n        <td id=\"file-watcher-py-LC32\" class=\"blob-code blob-code-inner js-file-line\">            <span class=pl-s1>self</span>.<span class=pl-s1>__src_path</span>,</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L33\" class=\"blob-num js-line-number\" data-line-number=\"33\"></td>\n        <td id=\"file-watcher-py-LC33\" class=\"blob-code blob-code-inner js-file-line\">            <span class=pl-s1>recursive</span><span class=pl-c1>=</span><span class=pl-c1>True</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L34\" class=\"blob-num js-line-number\" data-line-number=\"34\"></td>\n        <td id=\"file-watcher-py-LC34\" class=\"blob-code blob-code-inner js-file-line\">        )</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L35\" class=\"blob-num js-line-number\" data-line-number=\"35\"></td>\n        <td id=\"file-watcher-py-LC35\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L36\" class=\"blob-num js-line-number\" data-line-number=\"36\"></td>\n        <td id=\"file-watcher-py-LC36\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>if</span> <span class=pl-s1>__name__</span> <span class=pl-c1>==</span> <span class=pl-s>&quot;__main__&quot;</span>:</td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L37\" class=\"blob-num js-line-number\" data-line-number=\"37\"></td>\n        <td id=\"file-watcher-py-LC37\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>src_path</span> <span class=pl-c1>=</span> <span class=pl-s1>sys</span>.<span class=pl-s1>argv</span>[<span class=pl-c1>1</span>] <span class=pl-k>if</span> <span class=pl-en>len</span>(<span class=pl-s1>sys</span>.<span class=pl-s1>argv</span>) <span class=pl-c1>&gt;</span> <span class=pl-c1>1</span> <span class=pl-k>else</span> <span class=pl-s>&#39;.&#39;</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-watcher-py-L38\" class=\"blob-num js-line-number\" data-line-number=\"38\"></td>\n        <td id=\"file-watcher-py-LC38\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-v>ImagesWatcher</span>(<span class=pl-s1>src_path</span>).<span class=pl-en>run</span>()</td>\n      </tr>\n</table>\n\n\n  </div>\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/alfakini/2068679131598835add93575c85a3657/raw/845f951d1fb89715431154a1beef357581b943da/watcher.py\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/alfakini/2068679131598835add93575c85a3657#file-watcher-py\">watcher.py</a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div></p>\n<p>The <code class=\"language-text\">ImagesWatcher</code> class implements the <code class=\"language-text\">run</code> method that is responsible for starting and stoping the observer by pressing <code class=\"language-text\">Control-C</code>. Pay special attention to <code class=\"language-text\">watchdog.observers.Observer</code> and <code class=\"language-text\">images.events.ImagesEventHandler</code>. The <code class=\"language-text\">Observer</code> is the class that watches for any file system change and then dispatches the event to the <code class=\"language-text\">ImagesEventHandler</code>, the custom event handler we implemented to process the images.</p>\n<p>In the <code class=\"language-text\">ImagesEventHandler</code> we extend <code class=\"language-text\">RegexMatchingEventHandler</code> so we can take advantage of processing just events related with files with the jpg extension. By extending an event handler class provided by Watchdog we gain the ability to handle modified, created, deleted and moved <a href=\"https://pythonhosted.org/watchdog/api.html#event-classes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">events</a> by implementing the following methods:</p>\n<ul>\n<li><strong>on<em>any</em>event(event)</strong>: catch-all <a href=\"https://pythonhosted.org/watchdog/api.html#watchdog.events.FileSystemEvent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">file system events</a></li>\n<li><strong>on_created(event)</strong>: called when a <a href=\"https://pythonhosted.org/watchdog/api.html#watchdog.events.FileCreatedEvent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">file or directory is created</a></li>\n<li><strong>on_deleted(event)</strong>: called when a <a href=\"https://pythonhosted.org/watchdog/api.html#watchdog.events.FileCreatedEvent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">file or directory is deleted</a></li>\n<li><strong>on_modified(event)</strong>: called when a <a href=\"https://pythonhosted.org/watchdog/api.html#watchdog.events.FileModifiedEvent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">file or directory is changed</a></li>\n<li><strong>on_moved(event)</strong>: called when a <a href=\"https://pythonhosted.org/watchdog/api.html#watchdog.events.FileSystemMovedEvent\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">file or a directory is moved or renamed</a></li>\n</ul>\n<p>Each of these methods receives the related event object as a parameter. All event objects have the attributes <code class=\"language-text\">event_type</code>, <code class=\"language-text\">is_directory</code>, and <code class=\"language-text\">src_path</code>.</p>\n<p>To open and process the images we will use <a href=\"https://pillow.readthedocs.io/en/stable/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Pillow library</a>. The following code creates the thumbnail of images preserving aspect ratios with 128x128 maximum resolution and converts colors to gray scale. Also, in our event handler, we will implement just the <code class=\"language-text\">on_created</code> method to react just when a new file is created in the directory. All other events will still be handled as we’re extending <code class=\"language-text\">RegexMatchingEventHandler</code>. Note we define the constant <code class=\"language-text\">IMAGES_REGEX</code> where we indicate the file types we support:</p>\n<p><div id=\"gist92477775\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-events-py\" class=\"file my-2\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-python  \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip>\n      <tr>\n        <td id=\"file-events-py-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"></td>\n        <td id=\"file-events-py-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>import</span> <span class=pl-s1>os</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"></td>\n        <td id=\"file-events-py-LC2\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>from</span> <span class=pl-v>PIL</span> <span class=pl-k>import</span> <span class=pl-v>Image</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"></td>\n        <td id=\"file-events-py-LC3\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>from</span> <span class=pl-v>PIL</span>.<span class=pl-v>ImageOps</span> <span class=pl-k>import</span> <span class=pl-s1>grayscale</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"></td>\n        <td id=\"file-events-py-LC4\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>from</span> <span class=pl-s1>watchdog</span>.<span class=pl-s1>events</span> <span class=pl-k>import</span> <span class=pl-v>RegexMatchingEventHandler</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"></td>\n        <td id=\"file-events-py-LC5\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L6\" class=\"blob-num js-line-number\" data-line-number=\"6\"></td>\n        <td id=\"file-events-py-LC6\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>class</span> <span class=pl-v>ImagesEventHandler</span>(<span class=pl-v>RegexMatchingEventHandler</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L7\" class=\"blob-num js-line-number\" data-line-number=\"7\"></td>\n        <td id=\"file-events-py-LC7\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-v>THUMBNAIL_SIZE</span> <span class=pl-c1>=</span> (<span class=pl-c1>128</span>, <span class=pl-c1>128</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L8\" class=\"blob-num js-line-number\" data-line-number=\"8\"></td>\n        <td id=\"file-events-py-LC8\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-v>IMAGES_REGEX</span> <span class=pl-c1>=</span> [<span class=pl-s>r&quot;.*[^_thumbnail]\\.jpg$&quot;</span>]</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L9\" class=\"blob-num js-line-number\" data-line-number=\"9\"></td>\n        <td id=\"file-events-py-LC9\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L10\" class=\"blob-num js-line-number\" data-line-number=\"10\"></td>\n        <td id=\"file-events-py-LC10\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>__init__</span>(<span class=pl-s1>self</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L11\" class=\"blob-num js-line-number\" data-line-number=\"11\"></td>\n        <td id=\"file-events-py-LC11\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-en>super</span>().<span class=pl-en>__init__</span>(<span class=pl-s1>self</span>.<span class=pl-v>IMAGES_REGEX</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L12\" class=\"blob-num js-line-number\" data-line-number=\"12\"></td>\n        <td id=\"file-events-py-LC12\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L13\" class=\"blob-num js-line-number\" data-line-number=\"13\"></td>\n        <td id=\"file-events-py-LC13\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>on_created</span>(<span class=pl-s1>self</span>, <span class=pl-s1>event</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L14\" class=\"blob-num js-line-number\" data-line-number=\"14\"></td>\n        <td id=\"file-events-py-LC14\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>self</span>.<span class=pl-en>process</span>(<span class=pl-s1>event</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L15\" class=\"blob-num js-line-number\" data-line-number=\"15\"></td>\n        <td id=\"file-events-py-LC15\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L16\" class=\"blob-num js-line-number\" data-line-number=\"16\"></td>\n        <td id=\"file-events-py-LC16\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>def</span> <span class=pl-en>process</span>(<span class=pl-s1>self</span>, <span class=pl-s1>event</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L17\" class=\"blob-num js-line-number\" data-line-number=\"17\"></td>\n        <td id=\"file-events-py-LC17\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>filename</span>, <span class=pl-s1>ext</span> <span class=pl-c1>=</span> <span class=pl-s1>os</span>.<span class=pl-s1>path</span>.<span class=pl-en>splitext</span>(<span class=pl-s1>event</span>.<span class=pl-s1>src_path</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L18\" class=\"blob-num js-line-number\" data-line-number=\"18\"></td>\n        <td id=\"file-events-py-LC18\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>filename</span> <span class=pl-c1>=</span> <span class=pl-s>f&quot;<span class=pl-s1><span class=pl-kos>{</span><span class=pl-s1>filename</span><span class=pl-kos>}</span></span>_thumbnail.jpg&quot;</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L19\" class=\"blob-num js-line-number\" data-line-number=\"19\"></td>\n        <td id=\"file-events-py-LC19\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L20\" class=\"blob-num js-line-number\" data-line-number=\"20\"></td>\n        <td id=\"file-events-py-LC20\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>image</span> <span class=pl-c1>=</span> <span class=pl-v>Image</span>.<span class=pl-en>open</span>(<span class=pl-s1>event</span>.<span class=pl-s1>src_path</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L21\" class=\"blob-num js-line-number\" data-line-number=\"21\"></td>\n        <td id=\"file-events-py-LC21\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>image</span> <span class=pl-c1>=</span> <span class=pl-en>grayscale</span>(<span class=pl-s1>image</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L22\" class=\"blob-num js-line-number\" data-line-number=\"22\"></td>\n        <td id=\"file-events-py-LC22\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>image</span>.<span class=pl-en>thumbnail</span>(<span class=pl-s1>self</span>.<span class=pl-v>THUMBNAIL_SIZE</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events-py-L23\" class=\"blob-num js-line-number\" data-line-number=\"23\"></td>\n        <td id=\"file-events-py-LC23\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>image</span>.<span class=pl-en>save</span>(<span class=pl-s1>filename</span>)</td>\n      </tr>\n</table>\n\n\n  </div>\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/alfakini/7b2ae9f65ab51884e7db7906bd4eccf8/raw/d2084ab86db6a8425eb367d1a25c0236639637c1/events.py\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/alfakini/7b2ae9f65ab51884e7db7906bd4eccf8#file-events-py\">events.py</a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div></p>\n<p>That’s all needed to watch new files moved to our directory. Let’s run the watcher in a shell using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">python watcher.py /mnt</code></pre></div>\n<p>And open another one to move files:</p>\n<p><img src=\"/20a4020aaa9e69167b66150a6203aa0d/terminal.gif\" alt=\"Testing file system watcher\"></p>\n<p>You should see the logging messages and the files appearing in the directory.</p>\n<h2>Working with files in network mounted volumes</h2>\n<p>Now, let’s discuss a problem I faced when deploying it. When moving big files in a network mounted directory and the network connection isn’t good or when uploading big files, it can take time to finish moving the file. The problem is that the <code class=\"language-text\">on_created</code> event is dispatched when the file first appears in the directory and if you try to read the file you may find that it is corrupted because it didn’t finish uploading. To solve this problem, we have to change the <code class=\"language-text\">ImagesEventHandler</code> class and check if the file size is still increasing:</p>\n<p><div id=\"gist92477975\" class=\"gist\">\n    <div class=\"gist-file\">\n      <div class=\"gist-data\">\n        <div class=\"js-gist-file-update-container js-task-list-container file-box\">\n  <div id=\"file-events_two-py\" class=\"file my-2\">\n    \n\n  <div itemprop=\"text\" class=\"Box-body p-0 blob-wrapper data type-python  \">\n      \n<table class=\"highlight tab-size js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip>\n      <tr>\n        <td id=\"file-events_two-py-L1\" class=\"blob-num js-line-number\" data-line-number=\"1\"></td>\n        <td id=\"file-events_two-py-LC1\" class=\"blob-code blob-code-inner js-file-line\"><span class=pl-k>def</span> <span class=pl-en>on_created</span>(<span class=pl-s1>self</span>, <span class=pl-s1>event</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-events_two-py-L2\" class=\"blob-num js-line-number\" data-line-number=\"2\"></td>\n        <td id=\"file-events_two-py-LC2\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>file_size</span> <span class=pl-c1>=</span> <span class=pl-c1>-</span><span class=pl-c1>1</span></td>\n      </tr>\n      <tr>\n        <td id=\"file-events_two-py-L3\" class=\"blob-num js-line-number\" data-line-number=\"3\"></td>\n        <td id=\"file-events_two-py-LC3\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-k>while</span> <span class=pl-s1>file_size</span> <span class=pl-c1>!=</span> <span class=pl-s1>os</span>.<span class=pl-s1>path</span>.<span class=pl-en>getsize</span>(<span class=pl-s1>event</span>.<span class=pl-s1>src_path</span>):</td>\n      </tr>\n      <tr>\n        <td id=\"file-events_two-py-L4\" class=\"blob-num js-line-number\" data-line-number=\"4\"></td>\n        <td id=\"file-events_two-py-LC4\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>file_size</span> <span class=pl-c1>=</span> <span class=pl-s1>os</span>.<span class=pl-s1>path</span>.<span class=pl-en>getsize</span>(<span class=pl-s1>event</span>.<span class=pl-s1>src_path</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events_two-py-L5\" class=\"blob-num js-line-number\" data-line-number=\"5\"></td>\n        <td id=\"file-events_two-py-LC5\" class=\"blob-code blob-code-inner js-file-line\">        <span class=pl-s1>time</span>.<span class=pl-en>sleep</span>(<span class=pl-c1>1</span>)</td>\n      </tr>\n      <tr>\n        <td id=\"file-events_two-py-L6\" class=\"blob-num js-line-number\" data-line-number=\"6\"></td>\n        <td id=\"file-events_two-py-LC6\" class=\"blob-code blob-code-inner js-file-line\">\n</td>\n      </tr>\n      <tr>\n        <td id=\"file-events_two-py-L7\" class=\"blob-num js-line-number\" data-line-number=\"7\"></td>\n        <td id=\"file-events_two-py-LC7\" class=\"blob-code blob-code-inner js-file-line\">    <span class=pl-s1>self</span>.<span class=pl-en>process</span>(<span class=pl-s1>event</span>)</td>\n      </tr>\n</table>\n\n\n  </div>\n\n  </div>\n</div>\n\n      </div>\n      <div class=\"gist-meta\">\n        <a href=\"https://gist.github.com/alfakini/c434ce1ba8a48355e8d10bc1c7490700/raw/cde0abd1ebc5a329c58cc9f187f1c8172a3d4c3a/events_two.py\" style=\"float:right\">view raw</a>\n        <a href=\"https://gist.github.com/alfakini/c434ce1ba8a48355e8d10bc1c7490700#file-events_two-py\">events_two.py</a>\n        hosted with &#10084; by <a href=\"https://github.com\">GitHub</a>\n      </div>\n    </div>\n</div></p>\n<p>This way we avoid reading errors by checking if the transfer of the file is finished before processing it.</p>\n<h2>Wrapping Up</h2>\n<p>In this article we discussed the use of the <a href=\"https://pythonhosted.org/watchdog/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">watchdog Python library</a> to implement a toy project that monitors a directory creating a gray thumbnail for each new jpg file detected.</p>\n<p>There are unexpected problems that we can face like the problem I described when uploading files on a network mounted directory or big files. Unfortunately, because of limitations on the filesystem APIs, there isn’t good ways to solve them.</p>\n<p>The library can also be used to implement filesystem events watchers for more complex scenarios, for example: monitor log changes, configuration files changes to update variables values in memory, notify a user when a file is created or changed.</p>","frontmatter":{"title":"Filesystem events monitoring with Python","date":"October 23, 2018","description":"Recently I had to implement a shell utility to monitor when a file is added in a directory. In this post, I will describe how we used the watchdog Python library to implement the utility and the problems I faced in the way."}}},"pageContext":{"slug":"/filesystem-events-with-python/","previous":{"fields":{"authors":"Alan R. Fachini","categories":["Software Engineering"],"cover":"essays/react-native-modules/images/react-native.png","date":"2018-09-28T23:17:13.000Z","description":"Desenvolvendo um módulo nativo para iteroperabilidade do React Native com o iOS.","id":"2ad685f1-6394-58f9-8246-6527ffadfe7a","images":["essays/react-native-modules/images/react-native.png"],"published":true,"slug":"/react-native-modules/","tags":["react","ios","react native","programming"],"title":"Desenvolvimento de módulo nativos para React Native"}},"next":{"fields":{"authors":"Alan R. Fachini","categories":["Essays"],"cover":"essays/sistemas-de-ideias/images/raciocinio.png","date":"2019-06-02T23:17:13.000Z","description":"Tudo aquilo que pensamos, toda ideia, é um modelo do mundo real. São palavras, equações, mapas, banco de dados ou programas de computador, abstrações da realidade ou projeções de como nós gostaria que a realidade fosse. A forma como vemos a realidade é só um modelo mental do que é a realidade de fato. Alguns modelos podem ser melhores que outros, mas certamente todos estão em algum nível, errados.","id":"c6b0d1c7-5277-5836-8f28-fd835ea500d9","images":["essays/sistemas-de-ideias/images/raciocinio.png"],"published":true,"slug":"/sistemas-de-ideias/","tags":["ideology","systems theory"],"title":"Sistemas de ideias"}}}},"staticQueryHashes":["1573948755","2077707862","3569324193","857530042"]}